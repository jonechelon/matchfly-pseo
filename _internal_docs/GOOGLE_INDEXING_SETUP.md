# Google Indexing API - Setup Guide

This guide explains how to configure and use the `src/indexer.py` script to automatically send newly generated URLs to the Google Indexing API.

## üìã Index

1. [Prerequisites](#prerequisites)
2. [Service Account Configuration](#service-account-configuration)
3. [Install Dependencies](#install-dependencies)
4. [Local Usage](#local-usage)
5. [GitHub Actions Configuration](#github-actions-configuration)
6. [Troubleshooting](#troubleshooting)

---

## Prerequisites

- Python 3.8+
- Google Cloud Platform (GCP) account
- Project in Google Cloud Console
- Google Search Console configured for the domain

---

## Service Account Configuration

### Step 1: Create Service Account in Google Cloud Console

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Select your project (or create a new one)
3. Navigate to **IAM & Admin** ‚Üí **Service Accounts**
4. Click **Create Service Account**
5. Fill in:
   - **Name**: `matchfly-indexing-service`
   - **Description**: `Service account for Google Indexing API`
6. Click **Create and Continue**

### Step 2: Grant Permissions

1. On the **Grant this service account access to project** screen:
   - Role: **Editor** (or minimum necessary)
2. Click **Continue** ‚Üí **Done**

### Step 3: Create and Download JSON Key

1. In the Service Accounts list, click the created account
2. Go to the **Keys** tab
3. Click **Add Key** ‚Üí **Create new key**
4. Select **JSON**
5. Click **Create**
6. The JSON file will be downloaded automatically

### Step 4: Enable Google Indexing API

1. In Google Cloud Console, go to **APIs & Services** ‚Üí **Library**
2. Search for **"Indexing API"**
3. Click **Google Indexing API**
4. Click **Enable**

### Step 5: Verify Property in Google Search Console

1. Go to [Google Search Console](https://search.google.com/search-console)
2. Select your property (domain)
3. Go to **Settings** ‚Üí **Users and permissions**
4. Add the Service Account email (format: `name@project.iam.gserviceaccount.com`)
5. Grant **Owner** or **Full** permission

### Step 6: Save Credentials Locally

1. Rename the downloaded JSON file to `service_account.json`
2. Create the `credentials/` directory at project root (if it doesn't exist)
3. Move the file to `credentials/service_account.json`

```bash
mkdir -p credentials
mv ~/Downloads/your-project-xxxxx.json credentials/service_account.json
```

**‚ö†Ô∏è IMPORTANT:** The `credentials/` folder is in `.gitignore` and will **NOT** be committed to Git.

---

## Install Dependencies

Dependencies are already listed in `requirements.txt`. To install:

```bash
pip install -r requirements.txt
```

Or install only Google Indexing API dependencies:

```bash
pip install google-auth google-auth-oauthlib google-auth-httplib2 requests
```

---

## Local Usage

### Manual Execution

After generating pages with `src/generator.py`, run the indexer:

```bash
python3 src/indexer.py
```

### Execution via Pipeline

The `run_pipeline.sh` script already includes indexing automatically:

```bash
./run_pipeline.sh
```

The script checks if the credentials file exists before attempting to index. If it doesn't exist, it just warns and continues the pipeline normally.

### Script Behavior

- ‚úÖ **Reads** `docs/sitemap.xml` generated by `generator.py`
- ‚úÖ **Filters** only flight URLs (contains `/voo/`)
- ‚úÖ **Authenticates** using `credentials/service_account.json`
- ‚úÖ **Sends** `URL_UPDATED` requests for each URL
- ‚úÖ **Rate Limiting**: 100ms between requests, 1s between batches of 100 URLs
- ‚úÖ **Error Handling**: Continues even if some URLs fail
- ‚úÖ **Logging**: Generates `indexer.log` with details

### Example Output

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë               üîç GOOGLE INDEXING API - MatchFly                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

======================================================================
STEP 1: READING SITEMAP
======================================================================
üìñ Reading sitemap: docs/sitemap.xml
‚úÖ 25 flight URLs extracted from sitemap
üìä Total URLs to index: 25

======================================================================
STEP 2: AUTHENTICATION
======================================================================
üîê Authenticating with Service Account: credentials/service_account.json
‚úÖ Authentication successful

======================================================================
STEP 3: URL INDEXING
======================================================================
üì§ Starting indexing of 25 URLs...
   Rate limiting: 0.1s between requests
   Batches of up to 100 URLs

[1/25] Indexing: https://matchfly.org/voo/voo-latam-la3090-gru-atrasado.html
‚úÖ URL indexed: https://matchfly.org/voo/voo-latam-la3090-gru-atrasado.html
[2/25] Indexing: https://matchfly.org/voo/voo-gol-g31447-gru-cancelado.html
...

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    ‚úÖ INDEXING COMPLETED!                         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìä SUMMARY:
   ‚Ä¢ URLs processed:  25
   ‚Ä¢ Successes:        25
   ‚Ä¢ Failures:         0

üéâ URLs successfully sent to Google Indexing API!
```

---

## GitHub Actions Configuration

### Step 1: Create GitHub Secret

1. In your GitHub repository, go to **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
2. Click **New repository secret**
3. Configure:
   - **Name**: `GOOGLE_SERVICE_ACCOUNT_JSON`
   - **Secret**: Paste the complete content of the `service_account.json` file
4. Click **Add secret**

### Step 2: Verify Workflow

The `.github/workflows/update-flights.yml` workflow is already configured to:

1. ‚úÖ Install Google Auth dependencies
2. ‚úÖ Create credentials file from secret
3. ‚úÖ Run indexer after generating pages

**The workflow only runs indexing if the secret is configured.** If not, the pipeline continues normally without errors.

### Workflow Structure

```yaml
- name: 3. Setup Google Service Account (Optional)
  if: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON != '' }}
  run: |
    mkdir -p credentials
    echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}" > credentials/service_account.json

- name: 4. Index URLs to Google (Optional)
  if: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON != '' }}
  run: |
    python src/indexer.py || echo "‚ö†Ô∏è  Indexing failed or not configured (continuing...)"
```

---

## Troubleshooting

### Error: "Credentials file not found"

**Cause:** The `credentials/service_account.json` file doesn't exist.

**Solution:**
1. Verify the file was created correctly
2. Check path: should be `credentials/service_account.json` at project root
3. Script will continue normally without indexing (doesn't break pipeline)

---

### Error: "Invalid credentials" or "Authentication failed"

**Cause:** JSON file is corrupted or invalid.

**Solution:**
1. Verify JSON file is complete and valid
2. Try opening JSON in an editor to validate syntax
3. Re-download the key from Google Cloud Console

---

### Error: "Permission denied" or "403 Forbidden"

**Cause:** Service Account doesn't have permission in Google Search Console.

**Solution:**
1. Go to Google Search Console
2. Go to **Settings** ‚Üí **Users and permissions**
3. Add Service Account email (format: `name@project.iam.gserviceaccount.com`)
4. Grant **Owner** or **Full** permission

---

### Error: "API not enabled"

**Cause:** Google Indexing API is not enabled in the project.

**Solution:**
1. Go to Google Cloud Console
2. Go to **APIs & Services** ‚Üí **Library**
3. Search for **"Indexing API"**
4. Click **Enable**

---

### Error: "Rate limit exceeded" (429)

**Cause:** Too many requests in short time.

**Solution:**
- Script already implements automatic rate limiting
- If persists, increase delays in `src/indexer.py`:
  ```python
  DELAY_BETWEEN_REQUESTS = 0.2  # Increase to 200ms
  DELAY_BETWEEN_BATCHES = 2.0   # Increase to 2 seconds
  ```

---

### URLs don't appear in Google Search Console

**Cause:** Indexing may take a few minutes or hours.

**Solution:**
1. Wait a few hours after execution
2. Check in Google Search Console ‚Üí **URL Inspection**
3. Use "Request Indexing" tool manually to test
4. Check logs in `indexer.log` to confirm requests were sent

---

## API Limits and Quotas

- **Maximum requests per day**: Depends on your Google Cloud plan
- **Rate limiting**: Script implements automatic delays
- **Notification types**: `URL_UPDATED` (for new/updated) or `URL_DELETED` (for removed)

---

## Security

‚úÖ **The `credentials/` folder is in `.gitignore`** - will never be committed
‚úÖ **GitHub Secrets are encrypted** - safe for use in workflows
‚úÖ **Service Account has minimum permissions** - only Indexing API
‚úÖ **Script checks credentials before using** - doesn't break pipeline if missing

---

## References

- [Google Indexing API Documentation](https://developers.google.com/search/apis/indexing-api/v3/using-api)
- [Service Account Setup Guide](https://cloud.google.com/iam/docs/service-accounts)
- [Google Search Console](https://search.google.com/search-console)

---

## Support

If you encounter issues, check:
1. Logs in `indexer.log`
2. GitHub Actions logs (if running in CI/CD)
3. API status in Google Cloud Console
4. Permissions in Google Search Console

---

**Last updated:** 2026-01-22
